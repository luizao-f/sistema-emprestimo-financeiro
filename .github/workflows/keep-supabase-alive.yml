name: üîÑ Manter Supabase Ativo

on:
  schedule:
    # Executa segunda e quinta √†s 9h UTC (6h no Brasil)
    - cron: '0 9 * * 1,4'
  
  # Permite executar manualmente para testes
  workflow_dispatch:

permissions:
  contents: read

jobs:
  keep-alive:
    runs-on: ubuntu-latest
    
    # Timeout de 1 minuto
    timeout-minutes: 1
    
    steps:
      # Step 1: Fazer o ping com m√°xima seguran√ßa
      - name: üöÄ Executar Keep-Alive no Supabase
        env:
          # Os secrets s√£o automaticamente mascarados nos logs
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: |
          # Executar INSERT (mais confi√°vel que SELECT para manter ativo)
          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -X POST "${SUPABASE_URL}/rest/v1/keep_alive_log" \
            -H "Content-Type: application/json" \
            -H "apikey: ${SUPABASE_ANON_KEY}" \
            -H "Authorization: Bearer ${SUPABASE_ANON_KEY}" \
            -d '{"source":"github-actions"}')
          
          # Extrair c√≥digo HTTP (√∫ltima linha)
          HTTP_CODE=$(echo "$RESPONSE" | tail -n 1)
          
          # Verificar resposta
          if [ "$HTTP_CODE" = "201" ] || [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ Supabase Keep-Alive executado com sucesso!"
            echo "Timestamp: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
            exit 0
          else
            echo "‚ùå Erro ao executar keep-alive. HTTP Code: $HTTP_CODE"
            echo "Response: $(echo "$RESPONSE" | head -n -1)"
            exit 1
          fi
      
      # Step 2: Notificar sucesso
      - name: ‚úÖ Sucesso
        if: success()
        run: |
          echo "üéâ Projeto Supabase mantido ativo!"
          echo "Pr√≥xima execu√ß√£o: quinta-feira √†s 6h (hor√°rio de Bras√≠lia)"
      
      # Step 3: Notificar erro
      - name: ‚ùå Erro
        if: failure()
        run: |
          echo "‚ö†Ô∏è Falha ao manter Supabase ativo"
          echo "Verifique:"
          echo "1. Secrets est√£o configurados corretamente"
          echo "2. Tabela 'keep_alive_log' existe no Supabase"
          echo "3. Pol√≠tica de RLS permite INSERT"
